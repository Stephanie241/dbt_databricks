# dbt Health API Project (Databricks)

This project demonstrates an end-to-end **dbt pipeline** that:

1. Fetches health data from the **OpenFDA API**.
2. Stores it as a **seed** in dbt.
3. Creates a **staging model** in Databricks.
4. Aggregates the data in a **mart / summary model**.

---

## Project Structure

```
dbt_health_api_databricks/
│
├─ seeds/
│   └─ health_data_raw.csv       # Generated by Python API script
│
├─ api_scripts/
│   └─ fetch_health_data.py     # Python script to fetch & clean API data
│
├─ models/
│   ├─ staging/
│   │   ├─ st_health_data.sql   # Staging model
│   │   └─ schema.yml           # Tests for staging model
│   ├─ marts/
│   │   └─ health_summary.sql   # Aggregated mart model
│
└─ dbt_project.yml             
```

---

## Setup Instructions

#### Database Connection

The dbt connection settings are stored in your local `profiles.yml` file:

- macOS/Linux: `~/.dbt/profiles.yml`
- Windows: `C:\Users\<username>\.dbt\profiles.yml`

This file is **not included in the repo** for security reasons. Make sure your `dev` target is correctly configured to point to your Databricks catalog, schema, host, and token.

### 1. Create Virtual Environment

```bash
python -m venv .venv
source .venv/bin/activate  # macOS/Linux
# or
.venv\Scripts\activate     # Windows

pip install --upgrade pip
pip install dbt-databricks pandas requests
```

---

### 2. Fetch Health Data

Run the Python script to fetch and clean the API data:

```bash
python api_scripts/fetch_health_data.py
```

- Saves the cleaned CSV to `seeds/health_data_raw.csv`.
- Long text fields are truncated to avoid dbt seed errors.
- Column names are SQL-safe (no dots).

---

### 3. Load Seed into Databricks

```bash
dbt seed --select health_data_raw --target dev
```

- Creates table:  
  ```
  Catalog: dataandanalyticsdb
  Schema: dbt
  Table: health_data_raw
  ```

---

### 4. Run dbt Models

```bash
dbt run --target dev
```

- Creates **staging view**:

```
st_health_data
```

- Creates **mart / summary view**:

```
health_summary
```

---

### 5. Run Tests

```bash
dbt test --target dev
```

- Ensures important columns (`safetyreportid`, `drug`, `reaction`) are not null or duplicated.

---

### 6. Generate Documentation

```bash
dbt docs generate --target dev
dbt docs serve --target dev
```

- Provides interactive lineage, model descriptions, and column metadata.

---

## Table / View Summary

| Name               | Type      | Description                          | Location in Databricks                 |
|-------------------|----------|--------------------------------------|--------------------------------------|
| health_data_raw    | Table    | Raw API snapshot                     | dataandanalyticsdb.dbt               |
| st_health_data     | View     | Cleaned and flattened staging model  | dataandanalyticsdb.dbt               |
| health_summary     | View     | Aggregated events per drug           | dataandanalyticsdb.dbt               |

---

## Data Flow

```
OpenFDA API → Python Script → dbt Seed (health_data_raw) 
        → Staging Model (st_health_data) 
        → Mart / Summary Model (health_summary)
```

- Seed = raw snapshot  
- Staging = cleaned / SQL-ready  
- Mart = aggregated / analytics-ready  

---

## Notes

- Columns with dots in the API (e.g., `patient.drug`) are **renamed** to SQL-safe names (`patient_drug`).
- Long text fields are truncated to **1000 characters** to avoid dbt seed errors.
- Incremental loading can be added for regular API updates.

---

## References

- [dbt Documentation](https://docs.getdbt.com/)
- [Databricks Catalogs & Tables](https://docs.databricks.com/data/data-catalog.html)
- [OpenFDA API](https://open.fda.gov/apis/)